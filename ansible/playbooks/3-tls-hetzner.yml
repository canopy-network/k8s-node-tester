# TLS/Cert-Manager Setup Playbook
# This playbook installs cert-manager and configures Let's Encrypt certificates
# using Hetzner DNS for DNS-01 challenge
- name: setup TLS certificates with cert-manager
  hosts: server[0]
  gather_facts: false
  vars:
    # these should be defined in inventory or passed via --extra-vars
    email: "{{ tls.email }}"
    domain: "{{ tls.domain }}"
    hetzner_api_token: "{{ tls.hetzner_api_token }}"

  tasks:
    - name: create cert-manager namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: cert-manager
        state: present

    - name: add cert-manager helm repository
      kubernetes.core.helm_repository:
        name: jetstack
        repo_url: https://charts.jetstack.io
        state: present

    - name: add hetzner webhook helm repository
      kubernetes.core.helm_repository:
        name: hcloud
        repo_url: https://charts.hetzner.cloud
        state: present

    - name: install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        chart_version: v1.19.2
        release_namespace: cert-manager
        create_namespace: true
        values:
          crds:
            enabled: true
        state: present
        release_state: deployed

    - name: apply TLS manifests from cluster/tls/hetzner-tls.yml
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', '../../cluster/tls/hetzner-tls.yml') | from_yaml_all }}"
      vars:
        HETZNER_API_TOKEN: "{{ hetzner_api_token }}"
        EMAIL: "{{ email }}"
        DOMAIN: "{{ domain }}"

    - name: install hetzner webhook
      kubernetes.core.helm:
        name: cert-manager-webhook-hetzner
        chart_ref: hcloud/cert-manager-webhook-hetzner
        release_namespace: cert-manager
        state: present
        release_state: deployed

    - name: wait for cert-manager pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: cert-manager
        label_selectors:
          - app.kubernetes.io/name=cert-manager
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 120

    - name: display certificate status message
      ansible.builtin.debug:
        msg:
          - "TLS setup complete"
          - "Note: Certificate validation may take several minutes"
          - "After validation, restart pods behind traefik's reverse proxy for the certificate to take effect"
          - "Check certificate status with: kubectl get certificate -n cert-manager"
